<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>「性能优化」首屏时间指标到底如何采集？ | Yanxu Gong&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/blog/favicon.ico">
    <meta name="description" content="Personal blog based on Github Action + Vuepress">
    
    <link rel="preload" href="/blog/assets/css/0.styles.fe7b8328.css" as="style"><link rel="preload" href="/blog/assets/js/app.0f8eb2d3.js" as="script"><link rel="preload" href="/blog/assets/js/2.eca0bbc3.js" as="script"><link rel="preload" href="/blog/assets/js/28.cab3ae50.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.ceee7412.js"><link rel="prefetch" href="/blog/assets/js/11.543b8244.js"><link rel="prefetch" href="/blog/assets/js/12.cca7434b.js"><link rel="prefetch" href="/blog/assets/js/13.2bb24d0b.js"><link rel="prefetch" href="/blog/assets/js/14.78813775.js"><link rel="prefetch" href="/blog/assets/js/15.eced5059.js"><link rel="prefetch" href="/blog/assets/js/16.2fd2bec1.js"><link rel="prefetch" href="/blog/assets/js/17.2857c48d.js"><link rel="prefetch" href="/blog/assets/js/18.517af3ad.js"><link rel="prefetch" href="/blog/assets/js/19.15d85cd6.js"><link rel="prefetch" href="/blog/assets/js/20.e7a7bc83.js"><link rel="prefetch" href="/blog/assets/js/21.3672733c.js"><link rel="prefetch" href="/blog/assets/js/22.9ae9830f.js"><link rel="prefetch" href="/blog/assets/js/23.b3acaf99.js"><link rel="prefetch" href="/blog/assets/js/24.52c67ab9.js"><link rel="prefetch" href="/blog/assets/js/25.2a715d69.js"><link rel="prefetch" href="/blog/assets/js/26.e39f258d.js"><link rel="prefetch" href="/blog/assets/js/27.7cd0d4c8.js"><link rel="prefetch" href="/blog/assets/js/29.bd82d29f.js"><link rel="prefetch" href="/blog/assets/js/3.8e78d6c3.js"><link rel="prefetch" href="/blog/assets/js/30.d27bba02.js"><link rel="prefetch" href="/blog/assets/js/31.8c2f7bc7.js"><link rel="prefetch" href="/blog/assets/js/32.a1c8dd9e.js"><link rel="prefetch" href="/blog/assets/js/4.3a92aa40.js"><link rel="prefetch" href="/blog/assets/js/5.a2a1871d.js"><link rel="prefetch" href="/blog/assets/js/6.3179d0e2.js"><link rel="prefetch" href="/blog/assets/js/7.4dfaa3fb.js"><link rel="prefetch" href="/blog/assets/js/8.bd87ed77.js"><link rel="prefetch" href="/blog/assets/js/9.939969b8.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.fe7b8328.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Yanxu Gong's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/study/" class="nav-link router-link-active">
  学习
</a></div><div class="nav-item"><a href="/blog/photography/" class="nav-link">
  摄影
</a></div><div class="nav-item"><a href="/blog/emotion/" class="nav-link">
  情感
</a></div><div class="nav-item"><a href="/blog/about.html" class="nav-link">
  关于
</a></div> <a href="https://github.com/yanxugong/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/study/" class="nav-link router-link-active">
  学习
</a></div><div class="nav-item"><a href="/blog/photography/" class="nav-link">
  摄影
</a></div><div class="nav-item"><a href="/blog/emotion/" class="nav-link">
  情感
</a></div><div class="nav-item"><a href="/blog/about.html" class="nav-link">
  关于
</a></div> <a href="https://github.com/yanxugong/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <div class="carbon-ads"></div> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>学习</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/study/js-basis/you-do-not-konw-js.html" class="sidebar-link">你不知道的 JavaScript（中卷）</a></li><li><a href="/blog/study/js-basis/you-do-not-konw-js-down.html" class="sidebar-link">你不知道的 JavaScript（下卷）</a></li><li><a href="/blog/study/js-basis/variables-and-types.html" class="sidebar-link">「重学 JavaScript」变量和类型</a></li><li><a href="/blog/study/js-basis/prototype-and-prototype-chain.html" class="sidebar-link">「重学 JavaScript」原型和原型链</a></li><li><a href="/blog/study/js-basis/scope-and-closure.html" class="sidebar-link">「重学 JavaScript」作用域和闭包</a></li><li><a href="/blog/study/js-basis/implementation-mechanism.html" class="sidebar-link">「重学 JavaScript」执行机制</a></li><li><a href="/blog/study/js-basis/syntax-and-api.html" class="sidebar-link">「重学 JavaScript」语法和 API</a></li><li><a href="/blog/study/frame/deep-react-one.html" class="sidebar-link">深入 react 技术栈（一）</a></li><li><a href="/blog/study/frame/deep-react-two.html" class="sidebar-link">深入 react 技术栈（二）</a></li><li><a href="/blog/study/network/from-url-to-page-render.html" class="sidebar-link">说一说从 URL 输入到页面呈现到底发生了什么？</a></li><li><a href="/blog/study/algorithm/linked-list.html" class="sidebar-link">「重学算法」快速掌握链表题</a></li><li><a href="/blog/study/performance-optimization/first-screen.html" aria-current="page" class="active sidebar-link">「性能优化」首屏时间指标到底如何采集？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/study/performance-optimization/first-screen.html#一、前言" class="sidebar-link">一、前言</a></li><li class="sidebar-sub-header"><a href="/blog/study/performance-optimization/first-screen.html#二、采集方式" class="sidebar-link">二、采集方式</a></li><li class="sidebar-sub-header"><a href="/blog/study/performance-optimization/first-screen.html#三、performance" class="sidebar-link">三、Performance</a></li><li class="sidebar-sub-header"><a href="/blog/study/performance-optimization/first-screen.html#四、服务端模板类型指标采集" class="sidebar-link">四、服务端模板类型指标采集</a></li><li class="sidebar-sub-header"><a href="/blog/study/performance-optimization/first-screen.html#五、单页面类型指标采集" class="sidebar-link">五、单页面类型指标采集</a></li><li class="sidebar-sub-header"><a href="/blog/study/performance-optimization/first-screen.html#六、相关文章" class="sidebar-link">六、相关文章</a></li></ul></li><li><a href="/blog/study/engineering/vite.html" class="sidebar-link">「工程化」如何看待构建工具 Vite？</a></li><li><a href="/blog/study/engineering/webpack-loader.html" class="sidebar-link">「webpack 核心特性」loader</a></li><li><a href="/blog/study/engineering/webpack-plugin.html" class="sidebar-link">「webpack 核心特性」插件(plugin)</a></li><li><a href="/blog/study/engineering/webpack-main.html" class="sidebar-link">「webpack 核心特性」工作原理</a></li><li><a href="/blog/study/engineering/webpack-hmr.html" class="sidebar-link">「webpack 核心特性」模块热替换(HMR)</a></li><li><a href="/blog/study/server/go-getting-started.html" class="sidebar-link">Go 快速入门指南</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="「性能优化」首屏时间指标到底如何采集"><a href="#「性能优化」首屏时间指标到底如何采集" class="header-anchor">#</a> 「性能优化」首屏时间指标到底如何采集？</h1> <h2 id="一、前言"><a href="#一、前言" class="header-anchor">#</a> 一、前言</h2> <p>性能优化一方面是我们前端<strong>经常讨论</strong>的<strong>话题</strong>，另一方面也是我们<strong>面试</strong>过程中考察的<strong>重点</strong>。</p> <p>那么，如何来定义性能指标呢？</p> <p>这篇文章我们主要介绍一下<strong>首屏</strong>时间如何<strong>采集</strong>。</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/359210d4c6b14793a264038cbd8bafff~tplv-k3u1fbpfcp-watermark.image" alt="309F0856-0412-4b5a-ADBE-F63D63F35DE3.png"></p> <h2 id="二、采集方式"><a href="#二、采集方式" class="header-anchor">#</a> 二、采集方式</h2> <h3 id="_2-1-手动采集"><a href="#_2-1-手动采集" class="header-anchor">#</a> 2.1 手动采集</h3> <blockquote><p><strong>FMP</strong>（First Meaningful Paint）是指页面的主要内容出现在屏幕上所需的时间。</p></blockquote> <p>一般是通过埋点的方式进行， 比如在页面开始位置打上 <code>FMP.Start()</code>，在首屏结束位置打上 <code>FMP.End()</code>，利用 <code>FMP.End() - FMP.Start()</code> 获取到首屏时间。</p> <p>优点：</p> <ul><li>兼容性强，可以随情况变动。</li> <li>去中心化，各个业务负责自己的埋点代码。</li></ul> <p>缺点：</p> <ul><li>埋点代码会和业务代码严重耦合</li> <li>业务较多时，可能覆盖率不足</li></ul> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5b42ba2a1de6449481da6e81d5883f5c~tplv-k3u1fbpfcp-watermark.image" alt="d40d31bb2e8cc9dc4d253bfb5aab3ad2.gif"></p> <h3 id="_2-2-自动化采集"><a href="#_2-2-自动化采集" class="header-anchor">#</a> 2.2 自动化采集</h3> <p>引入一段通用的代码来做首屏时间自动化采集，引入过程中，除了必要的配置不需要做其他事情。</p> <p>优点：</p> <ul><li>独立性强，接入过程更自动化。</li></ul> <p>缺点：</p> <ul><li>个性化需求无法满足。</li></ul> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d3a2cc8dbfed4a80815cd2cb00771c99~tplv-k3u1fbpfcp-watermark.image" alt="52d9afa71d3663c0827dedf91520eae2.gif"></p> <h2 id="三、performance"><a href="#三、performance" class="header-anchor">#</a> 三、Performance</h2> <p><code>Performance</code> 接口可以获取到当前页面中与性能相关的信息。可以通过调用只读属性 <code>window.performance</code> 来获取。</p> <blockquote><p>感兴趣的同学可以在浏览器控制台试一试。</p></blockquote> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7932c3690f7440cfac373d9c9211e8d8~tplv-k3u1fbpfcp-watermark.image" alt="89C335AB-833C-4194-BDB1-D03F635C088E.png"></p> <h3 id="_3-1-performance-timing"><a href="#_3-1-performance-timing" class="header-anchor">#</a> 3.1 Performance.timing</h3> <p><code>PerformanceTiming</code> 接口是为保持向后兼容性而保留的传统接口，提供了在加载和使用当前页面期间发生的各种事件的<strong>性能计时信息</strong>。通过 <code>window.performance.timing</code> 获取。</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c0fd1db7d474675808604c4c4673662~tplv-k3u1fbpfcp-watermark.image" alt="EB5EB996-31B6-4c7c-A6C7-946FC2B529D0.png"></p> <p>各个时间戳和页面加载时间节点的对应关系如下图：</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f959adfae395414385ccd3ad9a422452~tplv-k3u1fbpfcp-watermark.image" alt="2756110782-5bf52d2c6aa4c_articlex.png"></p> <h3 id="_3-2-耗时计算"><a href="#_3-2-耗时计算" class="header-anchor">#</a> 3.2 耗时计算</h3> <ul><li>DNS 查询耗时：<code>domainLookupEnd - domainLookupStart</code></li> <li>TCP 连接耗时：<code>connectEnd - connectStart</code></li> <li>内容加载耗时：<code>responseEnd - requestStart</code></li> <li>firstbyte（首包时间）：<code>responseStart – domainLookupStart</code></li> <li>fpt（First Paint Time 首次渲染时间 / 白屏时间）：<code>responseEnd – fetchStart</code></li> <li>tti（Time to Interact 首次可交互时间）：<code>domInteractive – fetchStart</code></li> <li>ready（HTML 加载完成时间）：<code>domContentLoaded – fetchStart</code></li> <li>load（页面完全加载时间）：<code>loadEventStart – fetchStart</code></li></ul> <h2 id="四、服务端模板类型指标采集"><a href="#四、服务端模板类型指标采集" class="header-anchor">#</a> 四、服务端模板类型指标采集</h2> <p>服务端模板类型主要指 <code>SSR</code>。</p> <p>加载流程如下：</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/6db40d4910a449ba9b9c7ba50be50ac0~tplv-k3u1fbpfcp-watermark.image" alt="A5BF578A-F86E-4059-888C-1F43EF714661.png"></p> <p>当 <code>HTML</code> 文档加载解析完成的时候，就是首屏加载完成的时候。首屏时间可以参考浏览器开发者工具 <code>Network</code> 面板的 <code>DOMContentLoaded</code> 值。</p> <p>以<strong>掘金</strong>首页为例，这里获取的清缓存加载的 <code>DOMContentLoaded</code> 值为 <code>1.17s</code>，也就是说首屏时间是 <code>1.17s</code>，如下图：</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8d9f59f877fc4c37a006f57a1c28ef5c~tplv-k3u1fbpfcp-watermark.image" alt="F13C9F59-72FE-4597-A5B2-E06E4DFFC108.png"></p> <blockquote><p><code>domContentLoadedEventEnd</code> 指 HTML 文档加载完成时间。<code>fetchStart</code> 指页面初始进入的时间。</p></blockquote> <p>这个 <code>1.17s</code> 怎么来的呢？其实就是前面【三、Performance】-&gt;【3.2 耗时计算】章节我们说过的 ready（HTML 加载完成时间）：<code>domContentLoaded – fetchStart</code>。</p> <p>我们可以现场验算一下，如下图：</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/367ffb2e71e645f383c84d9d02c9b732~tplv-k3u1fbpfcp-watermark.image" alt="5605064E-6B2C-4ca4-BA92-BA4D8BB6811F.png"></p> <h2 id="五、单页面类型指标采集"><a href="#五、单页面类型指标采集" class="header-anchor">#</a> 五、单页面类型指标采集</h2> <p>单页面的首屏时间和 SSR 的首屏时间有什么不同吗？</p> <p>随着 Vue 和 React 等前端框架盛行，Performance 已无法准确的监控到页面的首屏时间。因为 <code>DOMContentLoaded</code> 的值只能表示<strong>空白页</strong>（当前页面 body 标签里面没有内容）加载花费的时间。浏览器需要先加载 JS , 然后再通过 JS 来渲染页面内容，这个时候<strong>单页面类型</strong>首屏才算渲染完成。</p> <p>那我们使用什么数据来当做首屏时间呢？</p> <p>如果在首屏渲染过程中，记录各个资源的加载时间，那么最后某个资源加载完的时间是不是就是首屏时间呢？<code>MutationObserver</code> 就可以做这件事情。</p> <blockquote><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver" target="_blank" rel="noopener noreferrer">MutationObserver<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 接口提供了监视对 DOM 树所做更改的能力。它被设计为旧的 Mutation Events 功能的替代品，该功能是 DOM3 Events 规范的一部分。</p></blockquote> <h3 id="_5-1-初始化监听"><a href="#_5-1-初始化监听" class="header-anchor">#</a> 5.1 初始化监听</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">initObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">supportTiming</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> time <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> performance<span class="token punctuation">.</span>timing<span class="token punctuation">.</span>fetchStart<span class="token punctuation">;</span>
        <span class="token keyword">let</span> bodyTarget <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>bodyTarget<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> score <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          score <span class="token operator">+=</span> <span class="token function">calculateScore</span><span class="token punctuation">(</span>bodyTarget<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token constant">SCORE_ITEMS</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            score<span class="token punctuation">,</span>
            t<span class="token operator">:</span> time
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token constant">SCORE_ITEMS</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            score<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            t<span class="token operator">:</span> time
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>observer<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      childList<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      subtree<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>readyState <span class="token operator">===</span> <span class="token string">&quot;complete&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>mark <span class="token operator">=</span> <span class="token string">'readyState'</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calFinallScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
        <span class="token string">&quot;load&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>mark <span class="token operator">=</span> <span class="token string">'load'</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calFinallScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token boolean">true</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
        <span class="token string">'beforeunload'</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>mark <span class="token operator">=</span> <span class="token string">'beforeunload'</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calFinallScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token boolean">true</span>
      <span class="token punctuation">)</span>
      <span class="token keyword">const</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token keyword">function</span> <span class="token function">listenTouchstart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          that<span class="token punctuation">.</span><span class="token function">calFinallScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>mark <span class="token operator">=</span> <span class="token string">'touch'</span><span class="token punctuation">;</span>
          window<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span><span class="token string">'touchstart'</span><span class="token punctuation">,</span> listenTouchstart<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
        <span class="token string">'touchstart'</span><span class="token punctuation">,</span>
        listenTouchstart<span class="token punctuation">,</span>
        <span class="token boolean">true</span>
      <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>我们通过 <code>MutationObserver</code> 来监听 Dom 的变化, 然后计算当前时刻 Dom 的分数。</p> <h3 id="_5-2-计算分数"><a href="#_5-2-计算分数" class="header-anchor">#</a> 5.2 计算分数</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">calculateScore</span><span class="token punctuation">(</span><span class="token parameter">el<span class="token punctuation">,</span> tiers<span class="token punctuation">,</span> parentScore</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> score <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tagName <span class="token operator">=</span> el<span class="token punctuation">.</span>tagName<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token string">&quot;SCRIPT&quot;</span> <span class="token operator">!==</span> tagName <span class="token operator">&amp;&amp;</span>
      <span class="token string">&quot;STYLE&quot;</span> <span class="token operator">!==</span> tagName <span class="token operator">&amp;&amp;</span>
      <span class="token string">&quot;META&quot;</span> <span class="token operator">!==</span> tagName <span class="token operator">&amp;&amp;</span>
      <span class="token string">&quot;HEAD&quot;</span> <span class="token operator">!==</span> tagName
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> childrenLen <span class="token operator">=</span> el<span class="token punctuation">.</span>children <span class="token operator">?</span> el<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>childrenLen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> childs <span class="token operator">=</span> el<span class="token punctuation">.</span>children<span class="token punctuation">,</span> len <span class="token operator">=</span> childrenLen <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> len <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> len<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          score <span class="token operator">+=</span> <span class="token function">calculateScore</span><span class="token punctuation">(</span>childs<span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">,</span> tiers <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> score <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>score <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>parentScore<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>el<span class="token punctuation">.</span>getBoundingClientRect <span class="token operator">&amp;&amp;</span> el<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>top <span class="token operator">&lt;</span> <span class="token constant">WH</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      score <span class="token operator">+=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">0.5</span> <span class="token operator">*</span> tiers<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> score<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>计算分数主要做这几件事情：</p> <ul><li>从 body 元素开始递归计算。</li> <li>排查无用的元素标签。</li> <li>如果元素超出屏幕就认为是 0 分。</li> <li>第一层的元素是 1 分，第二次的元素是 1 + (层数 * 0.5)，也就是 1.5 分，依次类推，最终得打整个 Dom 数的总体分数。</li></ul> <h3 id="_5-3-计算出-fmp"><a href="#_5-3-计算出-fmp" class="header-anchor">#</a> 5.3 计算出 FMP</h3> <p>我们通过 <code>MutationObserver</code> 得到了一个数组，数组的每一项就是每次 Dom 变化的时间和分数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> fmps <span class="token operator">=</span> <span class="token function">getFmp</span><span class="token punctuation">(</span><span class="token constant">SCORE_ITEMS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> record <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> o <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> o <span class="token operator">&lt;</span> fmps<span class="token punctuation">.</span>length<span class="token punctuation">;</span> o<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fmps<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">.</span>t <span class="token operator">&gt;=</span> fmps<span class="token punctuation">[</span>o <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> l <span class="token operator">=</span> fmps<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">.</span>score <span class="token operator">-</span> fmps<span class="token punctuation">[</span>o <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>score<span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">!</span>record <span class="token operator">||</span> record<span class="token punctuation">.</span>rate <span class="token operator">&lt;=</span> l<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span>record <span class="token operator">=</span> <span class="token punctuation">{</span>
        t<span class="token operator">:</span> fmps<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">.</span>t<span class="token punctuation">,</span>
        rate<span class="token operator">:</span> l<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>通过上面的代码，我们会得到最终的 <code>FMP</code> 的值，就是变化最大的这个 DOM 变化。此时 <code>FMP</code> 值就是 <code>SPA</code> 项目的首屏时间。</p> <h2 id="六、相关文章"><a href="#六、相关文章" class="header-anchor">#</a> 六、相关文章</h2> <ul><li><a href="http://www.alloyteam.com/2020/01/14184/" target="_blank" rel="noopener noreferrer">如何进行 web 性能监控?<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://www.infoq.cn/article/Dxa8aM44oz*Lukk5Ufhy" target="_blank" rel="noopener noreferrer">蚂蚁金服如何把前端性能监控做到极致?<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://zhuanlan.zhihu.com/p/350657764" target="_blank" rel="noopener noreferrer">统计页面首屏时间，很多人第一步就错了<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/yanxugong/blog/edit/main/docs/study/performance-optimization/first-screen.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">4/20/2021, 3:04:57 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/study/algorithm/linked-list.html" class="prev">
        「重学算法」快速掌握链表题
      </a></span> <span class="next"><a href="/blog/study/engineering/vite.html">
        「工程化」如何看待构建工具 Vite？
      </a>
      →
    </span></p></div> <div class="bsa-cpc-wrapper"><div class="bsa-cpc"></div></div></main></div><div class="global-ui"><div></div><!----></div></div>
    <script src="/blog/assets/js/app.0f8eb2d3.js" defer></script><script src="/blog/assets/js/2.eca0bbc3.js" defer></script><script src="/blog/assets/js/28.cab3ae50.js" defer></script>
  </body>
</html>
