<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>「webpack 核心特性」模块热替换(HMR) | Yanxu Gong&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/blog/favicon.ico">
    <meta name="description" content="Personal blog based on Github Action + Vuepress">
    
    <link rel="preload" href="/blog/assets/css/0.styles.a7ec6b95.css" as="style"><link rel="preload" href="/blog/assets/js/app.6eea5f31.js" as="script"><link rel="preload" href="/blog/assets/js/2.a12c5041.js" as="script"><link rel="preload" href="/blog/assets/js/14.68610d47.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.f99253b8.js"><link rel="prefetch" href="/blog/assets/js/11.95fd265b.js"><link rel="prefetch" href="/blog/assets/js/12.aa7d8342.js"><link rel="prefetch" href="/blog/assets/js/13.ba4ef28b.js"><link rel="prefetch" href="/blog/assets/js/15.bea85dff.js"><link rel="prefetch" href="/blog/assets/js/16.c1c2aec6.js"><link rel="prefetch" href="/blog/assets/js/17.ee4eb2f5.js"><link rel="prefetch" href="/blog/assets/js/18.504f9e55.js"><link rel="prefetch" href="/blog/assets/js/19.7ab92ca6.js"><link rel="prefetch" href="/blog/assets/js/20.abc613d5.js"><link rel="prefetch" href="/blog/assets/js/21.3deb333b.js"><link rel="prefetch" href="/blog/assets/js/22.f3314b53.js"><link rel="prefetch" href="/blog/assets/js/23.5b99c5fe.js"><link rel="prefetch" href="/blog/assets/js/24.6e5fdb9f.js"><link rel="prefetch" href="/blog/assets/js/25.ded7bbe3.js"><link rel="prefetch" href="/blog/assets/js/26.f116ad2e.js"><link rel="prefetch" href="/blog/assets/js/27.412e58fb.js"><link rel="prefetch" href="/blog/assets/js/28.45549d69.js"><link rel="prefetch" href="/blog/assets/js/29.ec954653.js"><link rel="prefetch" href="/blog/assets/js/3.0843c451.js"><link rel="prefetch" href="/blog/assets/js/30.8a532421.js"><link rel="prefetch" href="/blog/assets/js/31.e21d6c3f.js"><link rel="prefetch" href="/blog/assets/js/32.6446c70c.js"><link rel="prefetch" href="/blog/assets/js/4.f72f02c7.js"><link rel="prefetch" href="/blog/assets/js/5.0ffb442c.js"><link rel="prefetch" href="/blog/assets/js/6.f9de1d0d.js"><link rel="prefetch" href="/blog/assets/js/7.a7783ae6.js"><link rel="prefetch" href="/blog/assets/js/8.00a61c82.js"><link rel="prefetch" href="/blog/assets/js/9.6d20ce1c.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.a7ec6b95.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Yanxu Gong's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/study/" class="nav-link router-link-active">
  学习
</a></div><div class="nav-item"><a href="/blog/photography/" class="nav-link">
  摄影
</a></div><div class="nav-item"><a href="/blog/emotion/" class="nav-link">
  情感
</a></div><div class="nav-item"><a href="/blog/about.html" class="nav-link">
  关于
</a></div> <a href="https://github.com/yanxugong/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/study/" class="nav-link router-link-active">
  学习
</a></div><div class="nav-item"><a href="/blog/photography/" class="nav-link">
  摄影
</a></div><div class="nav-item"><a href="/blog/emotion/" class="nav-link">
  情感
</a></div><div class="nav-item"><a href="/blog/about.html" class="nav-link">
  关于
</a></div> <a href="https://github.com/yanxugong/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <div class="carbon-ads"></div> <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>学习</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/study/js-basis/you-do-not-konw-js.html" class="sidebar-link">你不知道的 JavaScript（中卷）</a></li><li><a href="/blog/study/js-basis/you-do-not-konw-js-down.html" class="sidebar-link">你不知道的 JavaScript（下卷）</a></li><li><a href="/blog/study/js-basis/variables-and-types.html" class="sidebar-link">「重学 JavaScript」变量和类型</a></li><li><a href="/blog/study/js-basis/prototype-and-prototype-chain.html" class="sidebar-link">「重学 JavaScript」原型和原型链</a></li><li><a href="/blog/study/js-basis/scope-and-closure.html" class="sidebar-link">「重学 JavaScript」作用域和闭包</a></li><li><a href="/blog/study/js-basis/implementation-mechanism.html" class="sidebar-link">「重学 JavaScript」执行机制</a></li><li><a href="/blog/study/js-basis/syntax-and-api.html" class="sidebar-link">「重学 JavaScript」语法和 API</a></li><li><a href="/blog/study/frame/deep-react-one.html" class="sidebar-link">深入 react 技术栈（一）</a></li><li><a href="/blog/study/frame/deep-react-two.html" class="sidebar-link">深入 react 技术栈（二）</a></li><li><a href="/blog/study/network/from-url-to-page-render.html" class="sidebar-link">说一说从 URL 输入到页面呈现到底发生了什么？</a></li><li><a href="/blog/study/algorithm/linked-list.html" class="sidebar-link">「重学算法」快速掌握链表题</a></li><li><a href="/blog/study/performance-optimization/first-screen.html" class="sidebar-link">「性能优化」首屏时间指标到底如何采集？</a></li><li><a href="/blog/study/engineering/vite.html" class="sidebar-link">「工程化」如何看待构建工具 Vite？</a></li><li><a href="/blog/study/engineering/webpack-loader.html" class="sidebar-link">「webpack 核心特性」loader</a></li><li><a href="/blog/study/engineering/webpack-plugin.html" class="sidebar-link">「webpack 核心特性」插件(plugin)</a></li><li><a href="/blog/study/engineering/webpack-main.html" class="sidebar-link">「webpack 核心特性」工作原理</a></li><li><a href="/blog/study/engineering/webpack-hmr.html" aria-current="page" class="active sidebar-link">「webpack 核心特性」模块热替换(HMR)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/study/engineering/webpack-hmr.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/blog/study/engineering/webpack-hmr.html#在应用程序中" class="sidebar-link">在应用程序中</a></li><li class="sidebar-sub-header"><a href="/blog/study/engineering/webpack-hmr.html#在-compiler-中" class="sidebar-link">在 compiler 中</a></li><li class="sidebar-sub-header"><a href="/blog/study/engineering/webpack-hmr.html#在模块中" class="sidebar-link">在模块中</a></li><li class="sidebar-sub-header"><a href="/blog/study/engineering/webpack-hmr.html#在-runtime-中" class="sidebar-link">在 runtime 中</a></li><li class="sidebar-sub-header"><a href="/blog/study/engineering/webpack-hmr.html#运用-hmr-的例子" class="sidebar-link">运用 HMR 的例子</a></li><li class="sidebar-sub-header"><a href="/blog/study/engineering/webpack-hmr.html#webpack-的-watch-模式" class="sidebar-link">webpack 的 watch 模式</a></li><li class="sidebar-sub-header"><a href="/blog/study/engineering/webpack-hmr.html#devserver-推送更新消息到浏览器" class="sidebar-link">devServer 推送更新消息到浏览器</a></li><li class="sidebar-sub-header"><a href="/blog/study/engineering/webpack-hmr.html#浏览器接收到服务端消息做出响应" class="sidebar-link">浏览器接收到服务端消息做出响应</a></li><li class="sidebar-sub-header"><a href="/blog/study/engineering/webpack-hmr.html#webpack-接收到最新-hash-值验证并请求模块代码" class="sidebar-link">webpack 接收到最新 hash 值验证并请求模块代码</a></li><li class="sidebar-sub-header"><a href="/blog/study/engineering/webpack-hmr.html#对模块进行热更新或刷新页面" class="sidebar-link">对模块进行热更新或刷新页面</a></li><li class="sidebar-sub-header"><a href="/blog/study/engineering/webpack-hmr.html#业务代码写法" class="sidebar-link">业务代码写法</a></li><li class="sidebar-sub-header"><a href="/blog/study/engineering/webpack-hmr.html#总结" class="sidebar-link">总结</a></li><li class="sidebar-sub-header"><a href="/blog/study/engineering/webpack-hmr.html#参考文章" class="sidebar-link">参考文章</a></li><li class="sidebar-sub-header"><a href="/blog/study/engineering/webpack-hmr.html#感谢" class="sidebar-link">感谢</a></li></ul></li><li><a href="/blog/study/server/go-getting-started.html" class="sidebar-link">Go 快速入门指南</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="「webpack-核心特性」模块热替换-hmr"><a href="#「webpack-核心特性」模块热替换-hmr" class="header-anchor">#</a> 「webpack 核心特性」模块热替换(HMR)</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <blockquote><p>模块热替换 (HMR - hot module replacement) 功能会在应用程序运行过程中，替换、添加或删除模块，而无需重新加载整个页面。主要是通过以下几种方式，来显著加快开发速度：</p></blockquote> <ul><li>保留在完全重新加载页面期间丢失的应用程序状态。</li> <li>只更新变更内容，以节省宝贵的开发时间。</li> <li>在源代码中 CSS/JS 产生修改时，会立刻在浏览器中进行更新，这几乎相当于在浏览器 devtools 直接更改样式。</li></ul> <p>这是官方网站对于 HMR 给的解释。</p> <p>下面我们来慢慢深入了解 Webpack HMR 原理。</p> <h2 id="在应用程序中"><a href="#在应用程序中" class="header-anchor">#</a> 在应用程序中</h2> <p>通过以下步骤，可以做到在应用程序中置换 (swap in and out) 模块：</p> <ol><li>应用程序要求 HMR runtime 检查更新。</li> <li>HMR runtime 异步地下载更新，然后通知应用程序。</li> <li>应用程序要求 HMR runtime 应用更新。</li> <li>HMR runtime 同步地应用更新。</li></ol> <p>你可以设置 HMR，以使此进程自动触发更新，或者你可以选择要求在用户交互时进行更新。</p> <p>白话大致原理：</p> <p>构建 bundle 时，加入一段 HMR runtime 的 js 和一段和服务沟通的 js （例如： <code>module.hot.accept('./index.js', function() {})</code>，后面会解释 ）。文件修改会触发 webpack 重新构建（webpack 的 watch 模式），服务器通过向浏览器发送更新消息（利用 websocket 长连接），浏览器通过 jsonp 拉取更新的模块文件，jsonp 回调触发模块热替换逻辑。</p> <p>对理论知识不感兴趣的同学，可以跳过理论直接看到<a href="#heading-5">运用 HMR 的例子</a>。</p> <h2 id="在-compiler-中"><a href="#在-compiler-中" class="header-anchor">#</a> 在 compiler 中</h2> <p>除了普通资源，compiler 需要发出 &quot;update&quot;，将之前的版本更新到新的版本。&quot;update&quot; 由两部分组成：</p> <ol><li>更新后的 manifest (JSON)</li> <li>一个或多个 updated chunk (JavaScript)</li></ol> <p>manifest 包括新的 compilation hash 和所有的 updated chunk 列表。每个 chunk 都包含着全部更新模块的最新代码（或一个 flag 用于表明此模块需要被移除）。</p> <p>compiler 会确保在这些构建之间的模块 ID 和 chunk ID 保持一致。通常将这些 ID 存储在内存中（例如，使用 webpack-dev-server 时），但是也可能会将它们存储在一个 JSON 文件中。</p> <h2 id="在模块中"><a href="#在模块中" class="header-anchor">#</a> 在模块中</h2> <p>HMR 是可选功能，只会影响包含 HMR 代码的模块。举个例子，通过 style-loader 为 style 追加补丁。为了运行追加补丁，style-loader 实现了 HMR 接口；当它通过 HMR 接收到更新，它会使用新的样式替换旧的样式。</p> <p>类似的，当在一个模块中实现了 HMR 接口，你可以描述出当模块被更新后发生了什么。然而在多数情况下，不需要在每个模块中强行写入 HMR 代码。如果一个模块没有 HMR 处理函数，更新就会冒泡 (bubble up) 。这意味着某个单独处理函数能够更新整个模块树。如果在模块树的一个单独模块被更新，那么整组依赖模块都会被重新加载。</p> <p>有关 module.hot 接口的详细信息，请查看 HMR API 页面。</p> <h2 id="在-runtime-中"><a href="#在-runtime-中" class="header-anchor">#</a> 在 runtime 中</h2> <p>这件事情比较有技术性……如果你对其内部不感兴趣，可以随时跳到 HMR API 页面 或 HMR 指南。</p> <p>对于模块系统运行时 (module system runtime) ，会发出额外代码，来跟踪模块 parents 和 children 关系。在管理方面，runtime 支持两个方法 check 和 apply。</p> <p>check 方法，发送一个 HTTP 请求来更新 manifest。如果请求失败，说明没有可用更新。如果请求成功，会将 updated chunk 列表与当前的 loaded chunk 列表进行比较。每个 loaded chunk 都会下载相应的 updated chunk。当所有更新 chunk 完成下载，runtime 就会切换到 ready 状态。</p> <p>apply 方法，将所有 updated module 标记为无效。对于每个无效 module，都需要在模块中有一个 update handler，或者在此模块的父级模块中有 update handler。否则，会进行无效标记冒泡，并且父级也会被标记为无效。继续每个冒泡，直到到达应用程序入口起点，或者到达带有 update handler 的 module（以最先到达为准，冒泡停止）。如果它从入口起点开始冒泡，则此过程失败。</p> <p>之后，所有无效 module 都会被（通过 dispose handler）处理和解除加载。然后更新当前 hash，并且调用所有 accept handler。runtime 切换回 idle 状态，一切照常继续。</p> <h2 id="运用-hmr-的例子"><a href="#运用-hmr-的例子" class="header-anchor">#</a> 运用 HMR 的例子</h2> <p>项目目录如下：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">--</span>somethings<span class="token punctuation">.</span>js<span class="token punctuation">;</span>
<span class="token operator">--</span>index<span class="token punctuation">.</span>js<span class="token punctuation">;</span>
<span class="token operator">--</span>index<span class="token punctuation">.</span>html<span class="token punctuation">;</span>
<span class="token operator">--</span><span class="token keyword">package</span><span class="token punctuation">.</span>json<span class="token punctuation">;</span>
<span class="token operator">--</span>webpack<span class="token punctuation">.</span>config<span class="token punctuation">.</span>js<span class="token punctuation">;</span>
</code></pre></div><p>项目中包含两个 js 文件，项目入口文件是 index.js 文件，somethings.js 文件是 index.js 文件的一个依赖，它会在 body 元素中添加一个包含 <code>hello world</code> 的 div 元素。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack.config.js</span>

<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;webpack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">&quot;./index.js&quot;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&quot;bundle.js&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">hot</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这里当我们设置 <code>devServer.hot</code> 为 <code>true</code> 后，并且在 <code>package.json</code> 文件中添加如下的 script 脚本：<code>&quot;start&quot;: &quot;webpack-dev-server --hot --open&quot;</code>。</p> <p>添加 <code>--hot</code> 配置项后，<code>devServer</code> 会告诉 webpack 自动引入 <code>HotModuleReplacementPlugin</code> 插件。</p> <p>然后我们改一下 <code>somethings.js</code> 内容：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// somethings.js</span>

<span class="token operator">-</span> <span class="token keyword">const</span> <span class="token function-variable function">hello</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'hello world'</span> <span class="token comment">// 将 hello world 字符串修改为 hello eleme</span>
<span class="token operator">+</span> <span class="token keyword">const</span> <span class="token function-variable function">hello</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'hello eleme'</span>
</code></pre></div><p>页面中 <code>hello world</code> 文本随即变成 <code>hello eleme</code>。</p> <p>是不是很神奇，为什么会这样？</p> <h2 id="webpack-的-watch-模式"><a href="#webpack-的-watch-模式" class="header-anchor">#</a> webpack 的 watch 模式</h2> <p>webpack-dev-server 里引用了 webpack-dev-middleware。</p> <p>webpack-dev-middleware 是通过调用 webpack 的 api 对文件系统 watch 的。watchOptions 如果没有配置的话，会取默认值。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//webpack-dev-server/lib/Server.js</span>

<span class="token function">setupDevMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// middleware for serving webpack bundle</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token function">webpackDevMiddleware</span><span class="token punctuation">(</span>
       <span class="token keyword">this</span><span class="token punctuation">.</span>compiler<span class="token punctuation">,</span>
       Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">logLevel</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>log<span class="token punctuation">.</span>options<span class="token punctuation">.</span>level <span class="token punctuation">}</span><span class="token punctuation">)</span>
   <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// webpack-dev-middleware/index.js</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   context<span class="token punctuation">.</span>watching <span class="token operator">=</span> compiler<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>watchOptions<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       context<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>stack <span class="token operator">||</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>details<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       context<span class="token punctuation">.</span>log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>details<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
   context<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>当文件发生变化时，重新编译输出 bundle.js。devServer 下，是没有文件会输出到 output.path 目录下的，这时 webpack 是把文件输出到了内存中。webpack 中使用的操作内存的库是 memory-fs，它是 NodeJS 原生 fs 模块内存版(in-memory)的完整功能实现，会将你请求的 url 映射到对应的内存区域当中，因此读写都比较快。</p></blockquote> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack-dev-middleware/lib/fs.js</span>

<span class="token keyword">const</span> isMemoryFs <span class="token operator">=</span>
<span class="token operator">!</span>isConfiguredFs <span class="token operator">&amp;&amp;</span>
<span class="token operator">!</span>compiler<span class="token punctuation">.</span>compilers <span class="token operator">&amp;&amp;</span>
compiler<span class="token punctuation">.</span>outputFileSystem <span class="token keyword">instanceof</span> <span class="token class-name">MemoryFileSystem</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
compiler<span class="token punctuation">.</span>outputFileSystem <span class="token operator">=</span> fs<span class="token punctuation">;</span>
fileSystem <span class="token operator">=</span> fs<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isMemoryFs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   fileSystem <span class="token operator">=</span> compiler<span class="token punctuation">.</span>outputFileSystem<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
   fileSystem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MemoryFileSystem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   compiler<span class="token punctuation">.</span>outputFileSystem <span class="token operator">=</span> fileSystem<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="devserver-推送更新消息到浏览器"><a href="#devserver-推送更新消息到浏览器" class="header-anchor">#</a> devServer 推送更新消息到浏览器</h2> <p>在启动 devServer 的时候，<code>sockjs</code> 在服务端和浏览器端建立了一个 <code>webSocket</code> 长连接，以便将 webpack 编译和打包的各个阶段状态告知浏览器，最关键的步骤还是 <code>webpack-dev-server</code> 调用 webpack api 监听 <code>compile</code> 的 <code>done</code> 事件，当 compile 完成后，<code>webpack-dev-server</code> 通过 <code>_sendStatus</code> 方法将编译打包后的新模块 hash 值发送到浏览器端。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack-dev-server/lib/Server.js</span>

compiler<span class="token punctuation">.</span><span class="token function">plugin</span><span class="token punctuation">(</span><span class="token string">'done'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// stats.hash 是最新打包文件的 hash 值</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_sendStats</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sockets<span class="token punctuation">,</span> stats<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>clientStats<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_stats <span class="token operator">=</span> stats<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
<span class="token class-name">Server</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">_sendStats</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">sockets<span class="token punctuation">,</span> stats<span class="token punctuation">,</span> force</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>force <span class="token operator">&amp;&amp;</span> stats <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>stats<span class="token punctuation">.</span>errors <span class="token operator">||</span> stats<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> stats<span class="token punctuation">.</span>assets <span class="token operator">&amp;&amp;</span> stats<span class="token punctuation">.</span>assets<span class="token punctuation">.</span><span class="token function">every</span><span class="token punctuation">(</span><span class="token parameter">asset</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span>asset<span class="token punctuation">.</span>emitted<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sockWrite</span><span class="token punctuation">(</span>sockets<span class="token punctuation">,</span> <span class="token string">'still-ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 调用 sockWrite 方法将 hash 值通过 websocket 发送到浏览器端</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sockWrite</span><span class="token punctuation">(</span>sockets<span class="token punctuation">,</span> <span class="token string">'hash'</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sockWrite</span><span class="token punctuation">(</span>sockets<span class="token punctuation">,</span> <span class="token string">'errors'</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>warnings<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sockWrite</span><span class="token punctuation">(</span>sockets<span class="token punctuation">,</span> <span class="token string">'warnings'</span><span class="token punctuation">,</span> stats<span class="token punctuation">.</span>warnings<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sockWrite</span><span class="token punctuation">(</span>sockets<span class="token punctuation">,</span> <span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="浏览器接收到服务端消息做出响应"><a href="#浏览器接收到服务端消息做出响应" class="header-anchor">#</a> 浏览器接收到服务端消息做出响应</h2> <p><code>webpack-dev-server</code> 修改了 webpack 配置中的 <code>entry</code> 属性，在里面添加了 <code>webpack-dev-client</code> 的代码，这样在最后的 <code>bundle.js</code> 文件中就会有接收 <code>websocket</code> 消息的代码了。</p> <p><code>webpack-dev-server/client</code> 当接收到 <code>type</code> 为 <code>hash</code> 消息后会将 <code>hash</code> 值暂存起来，当接收到 <code>type</code> 为 <code>ok</code> 的消息后对应用执行 <code>reload</code> 操作，如下图所示，<code>hash</code> 消息是在 <code>ok</code> 消息之前。</p> <p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ca4d6896409a46fab42b1dd36c2eb369~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p> <p>在 <code>reload</code> 操作中，<code>webpack-dev-server/client</code> 会根据 <code>hot</code> 配置决定是刷新浏览器还是对代码进行热更新（HMR）。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack-dev-server/client/index.js</span>

<span class="token function-variable function">hash</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">msgHash</span><span class="token punctuation">(</span><span class="token parameter">hash</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentHash <span class="token operator">=</span> hash<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token function-variable function">ok</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">msgOk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token function">reloadApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// ...</span>
<span class="token keyword">function</span> <span class="token function">reloadApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'[WDS] App hot update...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> hotEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack/hot/emitter'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    hotEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'webpackHotUpdate'</span><span class="token punctuation">,</span> currentHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'[WDS] App updated. Reloading...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    self<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先将 <code>hash</code> 值暂存到 <code>currentHash</code> 变量，当接收到 <code>ok</code> 消息后，对 <code>App</code> 进行 <code>reload</code>。如果配置了模块热更新，就调用 <code>webpack/hot/emitter</code> 将最新 <code>hash</code> 值发送给 webpack，然后将控制权交给 webpack 客户端代码。如果没有配置模块热更新，就直接调用 <code>location.reload</code> 方法刷新页面。</p> <h2 id="webpack-接收到最新-hash-值验证并请求模块代码"><a href="#webpack-接收到最新-hash-值验证并请求模块代码" class="header-anchor">#</a> webpack 接收到最新 hash 值验证并请求模块代码</h2> <p>如果配置了模块热更新，就调用 <code>webpack/hot/emitter</code> 将最新 <code>hash</code> 值发送给 webpack，然后将控制权交给 webpack 客户端代码。如果没有配置模块热更新，就进行 <code>liveReload</code> 的逻辑。<code>webpack/hot/dev-server</code> 中会监听 <code>webpack-dev-server/client-src</code> 发送的 <code>webpackHotUpdate</code> 消息,然后调用 <code>webpack/lib/HotModuleReplacement.runtime</code> 中的 <code>check</code> 方法，检测是否有新的更新：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// webpack/hot/dev-server.js</span>

<span class="token keyword">var</span> hotEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./emitter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hotEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;webpackHotUpdate&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">currentHash</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   lastHash <span class="token operator">=</span> currentHash<span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">upToDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;idle&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;info&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;[HMR] Checking for updates on the server...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// webpack/lib/HotModuleReplacement.runtime</span>

<span class="token keyword">function</span> <span class="token function">hotCheck</span><span class="token punctuation">(</span><span class="token parameter">apply</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token keyword">return</span> <span class="token function">hotDownloadManifest</span><span class="token punctuation">(</span>hotRequestTimeout<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">update</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token operator">...</span>
		<span class="token comment">/*globals chunkId */</span>
		<span class="token function">hotEnsureUpdateChunk</span><span class="token punctuation">(</span>chunkId<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">...</span>
		<span class="token keyword">return</span> promise<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">hotEnsureUpdateChunk</span><span class="token punctuation">(</span><span class="token parameter">chunkId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hotAvailableFilesMap<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       	hotWaitingFilesMap<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
   	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
       	hotRequestedFilesMap<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
       	hotWaitingFiles<span class="token operator">++</span><span class="token punctuation">;</span>
       	<span class="token function">hotDownloadUpdateChunk</span><span class="token punctuation">(</span>chunkId<span class="token punctuation">)</span><span class="token punctuation">;</span>
   	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在 <code>check</code> 过程中，主要调用了两个方法 <code>hotDownloadManifest</code> 和 <code>hotDownloadUpdateChunk</code>。<code>hotDownloadManifest</code> 是通过 Ajax 向服务器请求十分有更新的文件，如果有就返回对应的文件信息，<code>hotDownloadUpdateChunk</code> 是通过<code>jsonp</code> 的方式，请求最新的代码模块。</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/817fd2a00f734e44b074945186246756~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p> <p><code>hotDownloadManifest</code> 方法获取更新文件列表</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/ece78fbf7f8847099e3cd379c5b68484~tplv-k3u1fbpfcp-zoom-1.image" alt=""></p> <h2 id="对模块进行热更新或刷新页面"><a href="#对模块进行热更新或刷新页面" class="header-anchor">#</a> 对模块进行热更新或刷新页面</h2> <p>我们获得了更新的内容。接下来就可以进行更新了。这部分的逻辑在 <code>webpack/lib/HotModuleReplacement.runtime</code> 中。</p> <p>首先，更新过的模块，现在都属于 <code>outdated</code> 的模块，所以先找出过期的模块及其依赖:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//webpack/lib/HotModuleReplacement.runtime</span>

<span class="token keyword">function</span> <span class="token function">getAffectedStuff</span><span class="token punctuation">(</span><span class="token parameter">updateModuleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">var</span> outdatedModules <span class="token operator">=</span> <span class="token punctuation">[</span>updateModuleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token keyword">var</span> outdatedDependencies <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
   <span class="token operator">...</span>
   <span class="token keyword">return</span> <span class="token punctuation">{</span>
       <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;accepted&quot;</span><span class="token punctuation">,</span>
       <span class="token literal-property property">moduleId</span><span class="token operator">:</span> updateModuleId<span class="token punctuation">,</span>
       <span class="token literal-property property">outdatedModules</span><span class="token operator">:</span> outdatedModules<span class="token punctuation">,</span>
       <span class="token literal-property property">outdatedDependencies</span><span class="token operator">:</span> outdatedDependencies
   <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>根据调用的 Api 信息，对结果进行标注及处理。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">switch</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">case</span> <span class="token string">&quot;self-declined&quot;</span><span class="token operator">:</span>
       <span class="token operator">...</span>
       <span class="token keyword">break</span><span class="token punctuation">;</span>
   <span class="token keyword">case</span> <span class="token string">&quot;declined&quot;</span><span class="token operator">:</span>
       <span class="token operator">...</span>
       <span class="token keyword">break</span><span class="token punctuation">;</span>
   <span class="token keyword">case</span> <span class="token string">&quot;unaccepted&quot;</span><span class="token operator">:</span>
       <span class="token operator">...</span>
       <span class="token keyword">break</span><span class="token punctuation">;</span>
   <span class="token keyword">case</span> <span class="token string">&quot;accepted&quot;</span><span class="token operator">:</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>onAccepted<span class="token punctuation">)</span> options<span class="token punctuation">.</span><span class="token function">onAccepted</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
       doApply <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
       <span class="token keyword">break</span><span class="token punctuation">;</span>
   <span class="token keyword">case</span> <span class="token string">&quot;disposed&quot;</span><span class="token operator">:</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>onDisposed<span class="token punctuation">)</span> options<span class="token punctuation">.</span><span class="token function">onDisposed</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
       doDispose <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
       <span class="token keyword">break</span><span class="token punctuation">;</span>
   <span class="token keyword">default</span><span class="token operator">:</span>
       <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Unexception type &quot;</span> <span class="token operator">+</span> result<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从缓存中删除过期的模块和依赖</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// remove module from cache</span>
<span class="token keyword">delete</span> installedModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// when disposing there is no need to call dispose handler</span>
<span class="token keyword">delete</span> outdatedDependencies<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// remove &quot;parents&quot; references from all children</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> module<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token operator">...</span>
<span class="token punctuation">}</span>
<span class="token comment">// remove outdated dependency from module children</span>
<span class="token keyword">var</span> dependency<span class="token punctuation">;</span>
<span class="token keyword">var</span> moduleOutdatedDependencies<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> outdatedDependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>将新的模块添加到 <code>modules</code> 中，当下次调用 <code>webpack_require</code> (webpack 重写的 require 方法)方法的时候，就是获取到了新的模块代码了。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// insert new code</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span>moduleId <span class="token keyword">in</span> appliedUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>appliedUpdate<span class="token punctuation">,</span> moduleId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    modules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> appliedUpdate<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果在热更新过程中出现错误，热更新将回退到刷新浏览器，这部分代码在 <code>dev-server</code>代码中。</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>hot
  <span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">updatedModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>updatedModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> status <span class="token operator">=</span> module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;abort&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;fail&quot;</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="业务代码写法"><a href="#业务代码写法" class="header-anchor">#</a> 业务代码写法</h2> <p>当用新的模块代码替换老的模块后，但是我们的业务代码并不能知道代码已经发生变化，也就是说，当 somethings.js 文件修改后，我们需要在 index.js 文件中调用 HMR 的 accept 方法，添加模块更新后的处理函数，及时将 somethings 方法的返回值插入到页面中。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// index.js</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token string">&quot;./somethings.js&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token function">somethings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>流程梳理：</p> <ol><li>在 webpack 的 watch 模式下，文件系统中某一个文件发生修改，webpack 监听到文件变化，根据配置文件对模块重新编译打包。</li> <li><code>webpack-dev-middleware</code> 调用 webpack 暴露的 API 对代码变化进行监控。</li> <li>当我们在配置文件中配置了 <code>devServer.watchContentBase</code> 为 <code>true</code> 的时候，Server 会监听这些配置文件夹中静态文件的变化，变化后会通知浏览器端对应用进行 <code>live reload</code>，并将打包后的文件输出到了内存中。</li> <li>在浏览器端和服务端之间建立一个 <code>websocket</code> 长连接，将 webpack 编译打包的各个阶段的状态信息告知浏览器端，同时也包括第三步中 Server 监听静态文件变化的信息。</li> <li><code>webpack/hot/dev-server</code> 根据 <code>webpack-dev-server/client</code> 传给它的信息以及 <code>dev-server</code> 的配置决定是刷新浏览器呢还是进行模块热更新。</li> <li><code>HotModuleReplacement.runtime</code> 接收到上一步传递给他的新模块的 hash 值，它通过 <code>JsonpMainTemplate.runtime</code> 向 server 端发送 Ajax 请求，服务端返回一个 json，该 json 包含了所有要更新的模块的 hash 值，获取到更新列表后，该模块再次通过 jsonp 请求，获取到最新的模块代码。</li> <li><code>HotModulePlugin</code> 将会对新旧模块进行对比，决定是否更新模块，在决定更新模块后，检查模块之间的依赖关系，更新模块的同时更新模块间的依赖引用。</li> <li>当 HMR 失败后，回退到 <code>live reload</code> 操作，也就是进行浏览器刷新来获取最新打包代码。</li></ol> <h2 id="参考文章"><a href="#参考文章" class="header-anchor">#</a> 参考文章</h2> <ul><li><a href="https://zhuanlan.zhihu.com/p/30669007" target="_blank" rel="noopener noreferrer">Webpack HMR 原理解析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://juejin.im/post/6844903909773803534" target="_blank" rel="noopener noreferrer">Webpack 中的 HMR 原理<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h2 id="感谢"><a href="#感谢" class="header-anchor">#</a> 感谢</h2> <ul><li>图片来源网络。</li> <li>文中如有错误，欢迎在评论区批评指正。</li> <li>如果本文对你有帮助 😘，就点个<a href="https://github.com/yanxugong/blog" target="_blank" rel="noopener noreferrer">Star 👍<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 支持下吧！感谢阅读。</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/yanxugong/blog/edit/main/docs/study/engineering/webpack-hmr.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">5/27/2022, 12:50:44 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/study/engineering/webpack-main.html" class="prev">
        「webpack 核心特性」工作原理
      </a></span> <span class="next"><a href="/blog/study/server/go-getting-started.html">
        Go 快速入门指南
      </a>
      →
    </span></p></div> <div class="bsa-cpc-wrapper"><div class="bsa-cpc"></div></div></main></div><div class="global-ui"><div></div><!----></div></div>
    <script src="/blog/assets/js/app.6eea5f31.js" defer></script><script src="/blog/assets/js/2.a12c5041.js" defer></script><script src="/blog/assets/js/14.68610d47.js" defer></script>
  </body>
</html>
